<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Interactive Project Map</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
    }
    .container { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 350px;
      background: linear-gradient(135deg, rgba(15,93,244,1) 19%, rgba(33,200,117,1) 89%);
      color: white;
      padding: 30px 25px;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .sidebar h1 { font-size: 28px; margin-bottom: 15px; font-weight: 300; }
    .sidebar p { margin-bottom: 30px; opacity: 0.9; line-height: 1.5; }

    .filter-group { margin-bottom: 25px; }
    .filter-group label {
      display: block; margin-bottom: 8px;
      font-weight: 500; font-size: 14px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .filter-select {
      width: 100%; padding: 12px 15px; border: none;
      border-radius: 8px; background: white; color: #333;
      font-size: 14px; cursor: pointer; transition: all 0.3s ease;
    }
    .filter-select:focus { outline: none; box-shadow: 0 0 0 3px rgba(255,255,255,0.3); }

    .filter-btn {
      width: 100%; padding: 15px;
      background: #2c3e50; color: white; border: none; border-radius: 8px;
      font-size: 16px; font-weight: 600; cursor: pointer;
      transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .filter-btn:hover { background: #34495e; transform: translateY(-2px); }

    /* Desktop Results */
    .results-section {
      margin-top: 30px; padding-top: 25px;
      border-top: 1px solid rgba(255,255,255,0.2);
    }
    .results-header { font-size: 18px; margin-bottom: 20px; opacity: 0.9; }
    .project-card {
      background: rgba(255,255,255,0.1);
      padding: 15px; border-radius: 8px; margin-bottom: 15px;
      transition: all 0.3s ease; cursor: pointer;
    }
    .project-card:hover { background: rgba(255,255,255,0.2); transform: translateX(5px); }
    .project-title { font-weight: 600; margin-bottom: 5px; }
    .project-details { font-size: 12px; opacity: 0.8; }

    /* Map */
    .map-container { flex: 1; position: relative; }
    #map { height: 100%; width: 100%; min-height: 300px; }

    .map-info-note {
      position: absolute; top: 10px; left: 60px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 15px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000; font-size: 13px; color: #333;
      max-width: 280px; line-height: 1.4;
    }

    /* Popup */
    .leaflet-popup-content { text-align: center; min-width: 200px; }
    .popup-title { font-weight: bold; margin-bottom: 10px; font-size: 16px; color: #21C875; }
    .popup-details { margin-bottom: 10px; color: #666; font-size: 13px; }
    .leaflet-popup-content .popup-link {
      display: inline-block; background: #0F5DF4; color: #fff;
      padding: 8px 16px; border-radius: 5px; text-decoration: none; transition: background 0.3s ease;
    }
    .leaflet-popup-content .popup-link:hover { background: #21C875; }

    /* Mobile */
    .results-container-mobile { display: none; }

    @media (max-width: 768px) {
      .container { flex-direction: column; }
      .sidebar { width: 100%; padding: 20px 15px; }
      .results-section { display: none !important; }
      .results-container-mobile {
        display: block;
        background: linear-gradient(135deg, rgba(15,93,244,1) 19%, rgba(33,200,117,1) 89%);
        color: white; padding: 20px 15px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="sidebar">
      <h1>Filter Projects</h1>
      <p>Use the filters below to find the best option for you.</p>

      <div class="filter-group">
        <label for="analysisFilter">TOPIC</label>
        <select id="analysisFilter" class="filter-select">
          <option value="">All Topics</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="locationFilter">Location</label>
        <select id="locationFilter" class="filter-select">
          <option value="">All Locations</option>
        </select>
      </div>

      <button class="filter-btn" onclick="applyFilters()">APPLY FILTERS</button>

      <!-- ✅ Desktop results area -->
      <div class="results-section">
        <div class="results-header">Results (<span id="resultCount">0</span>)</div>
        <div id="resultsContainer"></div>
      </div>
    </div>

    <div class="map-container">
      <div class="map-info-note">
        <span class="info-icon">ℹ️</span>Note: Map markers show project locations. One project may have multiple locations.
      </div>
      <div id="map"></div>
    </div>

    <!-- ✅ Mobile results area -->
    <div class="results-container-mobile">
      <div class="results-header">Results (<span id="resultCountMobile">0</span>)</div>
      <div id="resultsContainerMobile"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>

  <script>
    const projects = [
            {
                id: 1,
                title: "Covid-19 Crisis: Atlas of Community Resilience",
                practiceAreas: ["COVID-19"], 
                locations: [
                    { name: "Malaysia", coordinates: [4.2105, 101.9758] }
                ],
                storyMapUrl: "https://storymaps.arcgis.com/stories/b2d924fe27b54e7e95a0b798cffd291f"
            },
            {
                id: 2,
                title: "Covid-19 Movement Control Order Effect on Kuala Lumpur",
                practiceAreas: ["COVID-19"], 
                locations: [
                    { name: "Kuala Lumpur", coordinates: [3.1319, 101.6841] }
                ],
                storyMapUrl: "https://storymaps.arcgis.com/stories/8bce45b4785c497682674396e8a80cf7"
            },
            {
                id: 3,
                title: "Demographics of GTWHS: Building Use, Population & Employment",
                practiceAreas: ["Demographic"], 
                locations: [
                    { name: "Penang", coordinates: [5.4141, 100.3285] }
                ],
                storyMapUrl: "https://storymaps.arcgis.com/stories/325dedcf0a064ce6989bb17cea4fd7cc"
            },
            {
                id: 4,
                title: "George Town World Heritage Site",
                practiceAreas: ["Baseline Study"],
                locations: [
                    { name: "Penang", coordinates: [5.4141, 100.3285] }
                ],
                storyMapUrl: "https://storymaps.arcgis.com/stories/059f3a83deff43489ba237ebdeb9e75f"
            },
            {
                id: 5,
                title: "Land Surface Temperature of Urban Areas in Malaysia",
                practiceAreas: ["Climate & Environment"],
                locations: [
                    { name: "Kuala Lumpur", coordinates: [3.1319, 101.6841] },
                    { name: "Penang", coordinates: [5.4141, 100.3285] },
                    { name: "Ipoh", coordinates: [4.6005, 101.0758] },
                    { name: "Johor Bahru", coordinates: [1.4799, 103.7643] }
                ],
                storyMapUrl: "https://arcg.is/1HreCm2"
            },
            {
                id: 6,
                title: "Safe Walk of Warisan Kuala Lumpur",
                practiceAreas: ["Urban Resilience"],
                locations: [
                    { name: "Kuala Lumpur", coordinates: [3.1319, 101.6841] }
                ],
                storyMapUrl: "https://storymaps.arcgis.com/stories/d636b83751c04e2ba894694ffed453ae"
            },
            {
                id: 7,
                title: "Warisan KL: Creative Industries and Cultural Services",
                practiceAreas: ["Creative & Cultural"], 
                locations: [
                    { name: "Kuala Lumpur", coordinates: [3.1319, 101.6841] },
                    { name: "Selangor", coordinates: [3.5092, 101.5248] },
                    { name: "Putrajaya", coordinates: [2.9264, 101.6964] }
                ],
                storyMapUrl: "https://arcg.is/qObWG1"
            }
        ];
    
    let map;
    let filteredProjects = [...projects];

    function initMap() {
      const isMobile = window.innerWidth <= 768;
      if (isMobile) setTimeout(initializeMap, 600);
      else initializeMap();
    }

    function initializeMap() {
      map = L.map('map').setView([4.2105, 101.9758], 7);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png').addTo(map);
      addMarkers(filteredProjects);
      populateFilters();
      updateResults();
      setTimeout(() => map.invalidateSize(), 1000);
    }

    function addMarkers(list) {
      if (window.markerClusterGroup) map.removeLayer(window.markerClusterGroup);
      window.markerClusterGroup = L.markerClusterGroup({ maxClusterRadius: 400 });
      list.forEach(p => p.locations.forEach(loc => {
        const m = L.marker(loc.coordinates)
          .bindPopup(`<b>${p.title}</b><br>${loc.name}<br><a href="${p.storyMapUrl}" target="_blank">View Story Map</a>`);
        window.markerClusterGroup.addLayer(m);
      }));
      map.addLayer(window.markerClusterGroup);
    }

    function populateFilters() {
      const topics = [...new Set(projects.flatMap(p => p.practiceAreas))];
      const locations = [...new Set(projects.flatMap(p => p.locations.map(l => l.name)))];
      const aSel = document.getElementById('analysisFilter');
      const lSel = document.getElementById('locationFilter');
      topics.forEach(t => aSel.insertAdjacentHTML('beforeend', `<option>${t}</option>`));
      locations.forEach(l => lSel.insertAdjacentHTML('beforeend', `<option>${l}</option>`));
    }

    function applyFilters() {
      const a = document.getElementById('analysisFilter').value;
      const l = document.getElementById('locationFilter').value;
      filteredProjects = projects.filter(p =>
        (!a || p.practiceAreas.includes(a)) &&
        (!l || p.locations.some(loc => loc.name === l))
      );
      addMarkers(filteredProjects);
      updateResults();
    }

    function updateResults() {
      const resDesk = document.getElementById('resultsContainer');
      const resMob = document.getElementById('resultsContainerMobile');
      const cDesk = document.getElementById('resultCount');
      const cMob = document.getElementById('resultCountMobile');
      resDesk.innerHTML = resMob.innerHTML = '';
      cDesk.textContent = cMob.textContent = filteredProjects.length;
      filteredProjects.forEach(p => {
        const html = `<div class="project-card" onclick="window.open('${p.storyMapUrl}', '_blank')">
          <div class="project-title">${p.title}</div>
          <div class="project-details">${p.practiceAreas.join(' | ')}<br>${p.locations.map(l => l.name).join(' | ')}</div>
        </div>`;
        resDesk.insertAdjacentHTML('beforeend', html);
        resMob.insertAdjacentHTML('beforeend', html);
      });
    }

    window.onload = initMap;
    window.onresize = () => map && map.invalidateSize();
  </script>
</body>
</html>
